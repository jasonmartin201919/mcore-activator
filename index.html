<script>
    async function requestKey() {
        const orderInput = document.getElementById('orderId');
        const orderId = orderInput.value.trim();
        const btn = document.getElementById('btnText');
        const resultArea = document.getElementById('resultArea');
        const keyCodeDisplay = document.getElementById('keyCode');

        // 1. 基础校验
        if (!orderId || orderId.length < 4) {
            alert('请输入正确的订单信息（至少4位）');
            return;
        }

        // 2. UI 状态切换
        btn.innerText = '正在连接云端数据库...';
        btn.disabled = true;

        try {
            // 3. 获取 pool.json (增加时间戳防止 GitHub Pages 缓存)
            const response = await fetch(`pool.json?t=${Date.now()}`);
            if (!response.ok) throw new Error('无法连接到码库');
            
            const data = await response.json();
            const pool = data.pool || [];

            if (pool.length === 0) {
                alert('库房补货中，请稍后再试或联系客服');
                btn.innerText = '立即领取激活码';
                btn.disabled = false;
                return;
            }

            // 4. 核心逻辑：根据订单号计算固定索引
            // 这样同一个订单号多次输入，领到的永远是同一个码
            let hash = 0;
            for (let i = 0; i < orderId.length; i++) {
                hash = ((hash << 5) - hash) + orderId.charCodeAt(i);
                hash |= 0; // 转换为 32 位整数
            }
            const index = Math.abs(hash) % pool.length;

            // 5. 解码并展示 (Base64 解码)
            const encryptedKey = pool[index];
            const decryptedKey = atob(encryptedKey); // 执行 Base64 解码

            // 模拟 1 秒加载感，增加仪式感
            await new Promise(resolve => setTimeout(resolve, 800));

            keyCodeDisplay.innerText = decryptedKey;
            resultArea.classList.remove('hidden');
            
            btn.innerText = '领取成功';
            btn.className = "w-full py-4 rounded-xl font-bold text-white bg-green-500 shadow-lg shadow-green-500/30";
            
        } catch (e) {
            console.error(e);
            alert('请求失败：' + e.message);
            btn.innerText = '立即领取激活码';
            btn.disabled = false;
        }
    }

    function copyKey() {
        const code = document.getElementById('keyCode').innerText;
        navigator.clipboard.writeText(code).then(() => {
            alert('激活码已复制！');
        });
    }
</script>
