<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MCORE 官方下载与授权中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #0f172a; --accent: #6366f1; --danger: #ef4444; }
        body { background-color: var(--bg); color: white; font-family: system-ui, sans-serif; overflow: hidden; }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .animate-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        /* 加载动画 */
        .loader { width: 48px; height: 48px; border: 5px solid #FFF; border-bottom-color: var(--accent); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div id="gateOverlay" class="fixed inset-0 z-[60] bg-[#0f172a] flex flex-col items-center justify-center space-y-6 transition-opacity duration-500">
    <span class="loader"></span>
    <div class="text-center">
        <h2 class="text-xl font-bold tracking-widest">安全环境检测中</h2>
        <p class="text-gray-500 text-xs mt-2">正在为您分配专属 30 分钟下载通道...</p>
    </div>
</div>

<div id="expireOverlay" class="hidden fixed inset-0 z-50 bg-[#0f172a]/95 backdrop-blur-md flex items-center justify-center p-6 text-center">
    <div class="max-w-sm space-y-6">
        <div class="w-16 h-16 bg-red-500/10 border border-red-500/30 rounded-full flex items-center justify-center mx-auto">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        </div>
        <h2 class="text-2xl font-bold">下载链接已失效</h2>
        <p class="text-gray-400 text-sm">链接有效期 30 分钟。出于安全考虑，授权链接仅限申请设备使用，转发无效。</p>
        <div class="p-6 bg-white/5 rounded-3xl border border-white/10">
            <p class="text-[10px] text-gray-500 mb-2 uppercase tracking-widest font-bold">WeChat Support</p>
            <p class="text-xl font-bold text-indigo-400">您的公众号名称</p>
        </div>
    </div>
</div>

<div id="mainContent" class="glass rounded-[2.5rem] w-full max-w-5xl shadow-2xl overflow-hidden flex flex-col md:flex-row min-h-[550px] opacity-0 transition-opacity duration-700">
    
    <div class="p-10 md:p-16 flex flex-col justify-center items-center md:items-start md:w-2/5 border-b md:border-b-0 md:border-r border-white/5 bg-white/5">
        <h1 class="text-6xl font-black mb-2 tracking-tighter">MCORE</h1>
        <p class="text-indigo-400 text-[10px] font-bold tracking-[0.4em] uppercase mb-12">Authorized Only</p>
        
        <a href="您的软件网盘链接" class="group flex items-center gap-4 px-10 py-5 bg-indigo-600 hover:bg-indigo-500 rounded-2xl transition-all shadow-lg shadow-indigo-500/20">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            <span class="font-bold tracking-widest text-sm">下载 MCORE 安装包</span>
        </a>
        <p class="mt-4 text-[10px] text-gray-500 font-medium italic">适用系统：Windows 10 / 11</p>
    </div>

    <div class="p-10 md:p-16 flex-1 flex flex-col justify-center bg-black/10">
        <div id="inputForm" class="space-y-8">
            <div class="space-y-2">
                <label class="text-[10px] text-gray-500 uppercase tracking-widest ml-1 font-bold">备案手机号</label>
                <input type="tel" id="phoneNum" placeholder="请输入购买时的手机号" 
                    class="w-full bg-white/5 border border-white/10 rounded-2xl px-8 py-5 focus:outline-none text-2xl font-mono transition-all focus:border-indigo-500/40 focus:bg-white/10">
            </div>
            <button onclick="handleBind()" id="activeBtn" class="w-full py-5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl font-bold tracking-[0.3em] text-sm transition-all active:scale-95">
                备案并获取激活码
            </button>
        </div>

        <div id="resultArea" class="hidden animate-up space-y-6">
            <div class="p-8 bg-white/5 rounded-[2rem] border border-white/10 text-center relative">
                <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-4 font-bold">Authorized Activation Key</p>
                <div id="keyCode" class="text-3xl md:text-4xl font-mono font-bold break-all mb-2"></div>
                <div id="statusTxt" class="text-[10px] opacity-40 italic">备案成功，请务必妥善保存</div>

                <div id="repeatBox" class="hidden mt-6 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl">
                    <p class="text-[11px] text-red-500 leading-relaxed font-bold">
                        该设备/手机号已完成授权备案。如有疑问或需要更换电脑，请咨询 mcoreservice@126.com 或公众号客服。
                    </p>
                </div>
            </div>

            <div class="flex items-center justify-between p-6 bg-indigo-500/5 border border-indigo-500/10 rounded-2xl">
                <div>
                    <p class="text-xs font-bold text-indigo-300">需要视频安装教程？</p>
                    <p class="text-[10px] text-gray-500 mt-1">微信搜一搜：您的公众号名</p>
                </div>
                <div class="px-4 py-2 bg-indigo-500/20 rounded-lg text-indigo-300 text-[10px] font-bold">回复 “激活”</div>
            </div>
        </div>
    </div>
</div>

<script>
    const WORKER_URL = "https://auth.maxus.work";
    let CURRENT_SID = new URLSearchParams(window.location.search).get('sid');
    let DEVICE_ID = "";

    // 1. 模拟 Gate 逻辑：获取机器码并生成/校验 SID
    async function initGate() {
        // 采集机器码指纹
        DEVICE_ID = btoa(navigator.userAgent + screen.width + (window.devicePixelRatio || 1)).slice(0, 16);
        console.log("Current Device Fingerprint:", DEVICE_ID);
        
        if (!CURRENT_SID) {
            console.log("No SID found, requesting new session...");
            try {
                const res = await fetch(`${WORKER_URL}/get-sid`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device: DEVICE_ID }) // 关键：申请时提交当前机器码
                });
                const data = await res.json();
                if (data.sid) {
                    window.location.replace(`?sid=${data.sid}`);
                } else {
                    throw new Error("SID generation failed");
                }
                return;
            } catch (e) { 
                console.error("Gate Error:", e);
                showExpire(); 
                return; 
            }
        }

        // 校验现有 SID：必须同时匹配 SID 和 DEVICE_ID
        try {
            console.log("Validating SID:", CURRENT_SID);
            // 关键修改：校验请求必须带上当前设备的 DEVICE_ID
            const check = await fetch(`${WORKER_URL}/check-sid?sid=${CURRENT_SID}&device=${DEVICE_ID}`);
            const status = await check.json();
            
            if (status.valid) {
                console.log("Access Granted");
                enterIndex();
            } else {
                console.warn("Access Denied: SID expired or device mismatch");
                showExpire();
            }
        } catch (e) { 
            console.error("Check Error:", e);
            showExpire(); 
        }
    }

    function enterIndex() {
        document.getElementById('gateOverlay').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('gateOverlay').style.display = 'none';
            document.getElementById('mainContent').style.opacity = '1';
        }, 500);
    }

    function showExpire() {
        document.getElementById('gateOverlay').style.display = 'none';
        document.getElementById('expireOverlay').classList.remove('hidden');
    }

    // 2. 备案绑定逻辑
    async function handleBind() {
        const phone = document.getElementById('phoneNum').value.trim();
        if (phone.length < 11) return alert("请输入正确的手机号");

        const btn = document.getElementById('activeBtn');
        btn.disabled = true;
        btn.innerText = "正在云端备案...";

        try {
            const response = await fetch(`${WORKER_URL}/bind`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sid: CURRENT_SID,
                    phone: phone,
                    device: DEVICE_ID // 绑定时再次提交，确保 Worker 端三方一致
                })
            });
            const result = await response.json();
            
            if (result.success) {
                renderResult(result.code, result.isRepeat);
            } else {
                alert(result.message || "备案失败");
            }
        } catch (e) { alert("服务器连接失败"); }
        finally { btn.disabled = false; btn.innerText = "备案并获取激活码"; }
    }

    function renderResult(code, isRepeat) {
        document.getElementById('inputForm').classList.add('hidden');
        const resArea = document.getElementById('resultArea');
        const keyDisp = document.getElementById('keyCode');
        
        keyDisp.innerText = code;
        if (isRepeat) {
            keyDisp.classList.add('text-red-500'); 
            document.getElementById('repeatBox').classList.remove('hidden');
            document.getElementById('statusTxt').innerText = "检测到重复备案";
        } else {
            keyDisp.classList.add('text-indigo-400');
        }
        resArea.classList.remove('hidden');
    }

    window.onload = initGate;
</script>
</body>
</html>
