<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MCORE 授权中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #0f172a; }
        .admin-mode { --bg: #1a150e; }
        body { background-color: var(--bg); transition: all 0.6s ease; color: white; font-family: system-ui; }
        .glass { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.05); }
        .admin-mode .glass { background: rgba(45, 38, 25, 0.6); border: 1px solid rgba(212, 175, 55, 0.2); }
        .gold-glow { color: #d4af37 !important; text-shadow: 0 0 15px rgba(212, 175, 55, 0.3); }
        .animate-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        input::placeholder { color: rgba(156, 163, 175, 0.5); font-size: 0.9rem; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 antialiased">

<div id="mainContainer" class="glass p-10 md:p-14 rounded-[3rem] w-full max-w-md shadow-2xl transition-all duration-700">
    <div class="text-center mb-10">
        <h1 id="brand" class="text-3xl font-black italic tracking-tighter transition-all">MCORE</h1>
        <p id="subTitle" class="text-gray-400 text-sm font-bold tracking-widest mt-2 uppercase">数据授权中心</p>
    </div>

    <div class="space-y-4">
        <input type="text" id="orderId" oninput="checkSuper(this.value)" placeholder="请输入授权订单号" 
            class="w-full bg-black/30 border border-white/5 rounded-2xl px-6 py-4 focus:outline-none text-center font-mono text-lg transition-all">
        
        <div class="flex items-center gap-4 px-4">
            <div class="h-[1px] flex-1 bg-white/5"></div>
            <span class="text-[10px] text-gray-600 font-bold uppercase tracking-widest">AND</span>
            <div class="h-[1px] flex-1 bg-white/5"></div>
        </div>

        <input type="tel" id="phoneNum" oninput="checkSuper(this.value)" placeholder="请输入购买手机号" 
            class="w-full bg-black/30 border border-white/5 rounded-2xl px-6 py-4 focus:outline-none text-center font-mono text-lg transition-all">
        
        <button onclick="process()" id="actionBtn" class="w-full mt-4 py-4 bg-indigo-600 rounded-2xl font-bold tracking-widest transition-all shadow-xl hover:brightness-110 active:scale-[0.98]">
            开始安全提取
        </button>

        <div id="resultArea" class="hidden mt-8 p-6 bg-black/40 rounded-3xl border border-white/5 border-dashed text-center animate-up">
            <p id="label" class="text-[9px] text-gray-500 uppercase tracking-widest mb-3 italic">Authorized Key</p>
            <div id="keyCode" class="text-xl font-mono font-bold break-all select-all tracking-wider text-indigo-400"></div>
            <div id="status" class="mt-4 text-[9px] opacity-40 italic">数据已于云端实时同步</div>
        </div>
    </div>
</div>

<script>
    // ！！！请确保你的 Worker 允许 GET 请求并能正确返回 GitHub 仓库内容
    const WORKER_URL = "https://mcore-api-proxy.m872096549.workers.dev";
    const POOL_RAW = "https://raw.githubusercontent.com/jasonmartin201919/mcore-activator/main/pool.json";
    const SUPER_CODE = "940715";

    function checkSuper(val) {
        const isSuper = (val.trim() === SUPER_CODE);
        const btn = document.getElementById('actionBtn');
        const brand = document.getElementById('brand');
        const sub = document.getElementById('subTitle');
        
        if (isSuper) {
            document.body.classList.add('admin-mode');
            brand.classList.add('gold-glow');
            sub.innerText = "超级权限提取模式";
            btn.innerText = "立即提取库存";
        } else {
            document.body.classList.remove('admin-mode');
            brand.classList.remove('gold-glow');
            sub.innerText = "数据授权中心";
            btn.innerText = "开始安全提取";
        }
    }

    async function process() {
        const order = document.getElementById('orderId').value.trim();
        const phone = document.getElementById('phoneNum').value.trim();
        const btn = document.getElementById('actionBtn');
        
        if(!order || !phone) {
            alert("请完整填写订单号和手机号");
            return;
        }

        btn.classList.add('loading');
        btn.innerText = "正在检索授权库...";

        try {
            // 1. 获取公库数据 - 优先尝试直接获取，失败则报错
            // 注意：为了防止缓存，加上时间戳
            const resPool = await fetch(`${POOL_RAW}?t=${Date.now()}`);
            if (!resPool.ok) throw new Error("无法连接至 GitHub 授权库");
            
            const poolData = await resPool.json();
            const pool = poolData.pool || [];

            if (!Array.isArray(pool) || pool.length === 0) {
                render("库存不足", "text-red-500", "授权公库当前为空，请联系客服补货");
                return;
            }

            // 2. 确定目标激活码 (基于订单+手机的确定性算法)
            let hash = 0;
            const seed = order + phone;
            for (let i = 0; i < seed.length; i++) {
                hash = ((hash << 5) - hash) + seed.charCodeAt(i);
            }
            const targetIndex = Math.abs(hash) % pool.length;
            const targetCode = pool[targetIndex].code;

            btn.innerText = "正在云端绑定身份...";

            // 3. 安全写入 db.json (通过 Worker)
            const success = await saveBindingToDB(targetCode, order, phone);

            if (success) {
                render(targetCode, "text-indigo-400", "提取成功：已完成设备指纹预绑定");
            } else {
                render("同步失败", "text-red-400", "云端握手超时，请检查网络后重试");
            }

        } catch (e) {
            console.error(e);
            alert("通信异常: " + e.message);
        } finally {
            btn.classList.remove('loading');
            btn.innerText = (order === SUPER_CODE) ? "立即提取库存" : "开始安全提取";
        }
    }

    async function saveBindingToDB(code, order, phone) {
        try {
            // A. 获取当前数据库状态
            const getRes = await fetch(WORKER_URL);
            if (!getRes.ok) return false;
            
            const fileData = await getRes.json();
            // 兼容 GitHub API 的 Base64 解析逻辑
            const contentDecoded = decodeURIComponent(escape(atob(fileData.content)));
            const db = JSON.parse(contentDecoded);

            // B. 查找或更新
            let keyObj = db.keys.find(k => k.code === code);
            const now = new Date();
            const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;

            if (keyObj) {
                // 如果已绑定且手机号不符，说明算法冲突（极低概率）
                if (keyObj.phone && keyObj.phone !== phone) {
                    // 尝试找下一个可用的
                    return false; 
                }
                keyObj.order_id = order;
                keyObj.phone = phone;
                keyObj.active_date = dateStr;
            } else {
                db.keys.push({
                    code: code,
                    mid: "",
                    order_id: order,
                    phone: phone,
                    status: "unused",
                    active_date: dateStr,
                    reset_history: [],
                    geo: { province: "", city: "", district: "", road: "", ip: "" }
                });
            }

            // C. 提交回 Worker
            const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(db, null, 2))));
            const putRes = await fetch(WORKER_URL, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Client-Bound: ${code}`,
                    content: updatedContent,
                    sha: fileData.sha
                })
            });

            return putRes.ok;
        } catch (err) {
            console.error("Worker Sync Error:", err);
            return false;
        }
    }

    function render(code, colorClass, statusTxt) {
        const resArea = document.getElementById('resultArea');
        const keyDisp = document.getElementById('keyCode');
        keyDisp.innerText = code;
        keyDisp.className = `text-xl font-mono font-bold tracking-wider select-all ${colorClass}`;
        document.getElementById('status').innerText = statusTxt;
        resArea.classList.remove('hidden');
    }
</script>
</body>
</html>
